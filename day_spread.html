<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Расклад на день - Таро</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            -webkit-tap-highlight-color: transparent;
            outline: none !important;
            -webkit-touch-callout: none !important;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
        }

        body {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            font-family: Georgia, serif;
            user-select: none;
            -webkit-user-select: none;
            touch-action: pan-y;
        }

        .app {
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
            background: url('images/bg-new.jpg') center center no-repeat;
            background-size: cover;
        }

        .topbar {
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .topbar h1 {
            font-weight: 700;
            font-size: 20px;
            color: #fff;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .cards-grid {
            width: 100%;
            max-width: 360px;
            margin: 24px auto 0;
            padding: 0 16px;
            display: grid;
            grid-template-columns: repeat(3, 106px);
            grid-template-rows: 190px;
            gap: 12px;
            justify-content: center;
        }

        .card-slot {
            width: 106px;
            height: 190px;
            position: relative;
            perspective: 1000px;
        }

        .card-slot-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }

        .card-slot.flipped .card-slot-inner {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 0;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        .card-empty {
            background: rgba(20, 44, 52, 0.3);
            border: none;
            border-radius: 0;
            box-shadow: 0 0 0 1px rgba(248, 252, 255, 0.15) inset,
                        0 8px 20px rgba(0, 0, 0, 0.3);
            z-index: 2;
        }

        .card-back-face {
            background: url("images/back-of-the-card-new.png") center/cover no-repeat;
            border: none;
            border-radius: 0;
            box-shadow: 0 0 0 1px rgba(248, 252, 255, 0.3) inset,
                        0 8px 20px rgba(0, 0, 0, 0.5);
            z-index: 2;
        }

        .card-front-face {
            background: #fff;
            transform: rotateY(180deg);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: none;
            border-radius: 0;
            box-shadow: 0 0 0 1px rgba(248, 252, 255, 0.3) inset,
                        0 8px 20px rgba(0, 0, 0, 0.5);
        }

        .card-front-face img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: high-quality;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .hint {
            text-align: center;
            color: #b7c7d5;
            line-height: 1.35;
            font-size: 13px;
            margin: 24px 16px 0;
            transition: opacity 0.35s ease;
        }

        .fan-wrapper {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            height: 35vh;
            overflow: hidden;
            pointer-events: none;
            z-index: 100;
        }

        .fan-container {
            position: absolute;
            width: 1600px;
            height: 56vh;
            left: 50%;
            bottom: calc(-56vh + 35vh);
            transform: translateX(-50%);
            pointer-events: auto;
            cursor: grab;
        }

        .fan-container:active {
            cursor: grabbing;
        }

        .fan-card {
            position: absolute;
            width: 106px;
            height: 190px;
            left: 50%;
            bottom: 0;
            margin-left: -53px;
            transform-origin: center 33.5vh;
            pointer-events: auto;
            cursor: pointer;
            outline: none !important;
            border: none !important;
            -webkit-tap-highlight-color: rgba(0,0,0,0) !important;
            -webkit-tap-highlight-color: transparent !important;
            -webkit-touch-callout: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
            touch-action: none !important;
            border-radius: 0;
            overflow: hidden;
            box-shadow: 
                0 2px 6px rgba(0, 0, 0, 0.4),
                0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .fan-card:focus,
        .fan-card:active,
        .fan-card:focus-visible {
            outline: none !important;
            border: none !important;
        }

        .fan-card::before,
        .fan-card::after {
            display: none !important;
        }

        .fan-card img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 0;
            border: none !important;
            box-shadow: none !important;
            pointer-events: none;
            outline: none !important;
            -webkit-user-drag: none;
            -webkit-tap-highlight-color: rgba(0,0,0,0) !important;
            background: transparent;
            display: block;
            touch-action: none !important;
        }

        .fan-card img:focus,
        .fan-card img:active {
            outline: none !important;
            border: none !important;
        }

        .fan-card.animating-copy {
            outline: none !important;
            border: none !important;
            -webkit-tap-highlight-color: rgba(0,0,0,0) !important;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4),
                        0 4px 12px rgba(0, 0, 0, 0.3) !important;
        }

        .fan-edge-indicator {
            position: absolute;
            width: 20px;
            height: 100%;
            top: 0;
            background: linear-gradient(90deg, rgba(22, 39, 52, 0) 0%, rgba(22, 39, 52, 0.8) 100%);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .fan-edge-indicator.left {
            left: 0;
            background: linear-gradient(270deg, rgba(22, 39, 52, 0) 0%, rgba(22, 39, 52, 0.8) 100%);
        }

        .fan-edge-indicator.right {
            right: 0;
        }

        .fan-edge-indicator.visible {
            opacity: 1;
        }

        .choose {
            position: absolute;
            left: 50%;
            bottom: 10px;
            transform: translateX(-50%);
            text-align: center;
            color: rgba(183, 199, 213, 0.9);
            font-size: 13px;
            pointer-events: none;
            transition: opacity 0.35s ease;
            z-index: 10;
        }

        .curved-arrow {
            position: absolute;
            left: 50%;
            bottom: 28px;
            transform: translateX(-50%);
            width: 240px;
            height: 30px;
            pointer-events: none;
            z-index: 9;
        }

        .curved-arrow svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        .curved-arrow path {
            fill: none;
            stroke: rgba(183, 199, 213, 0.6);
            stroke-width: 1.5;
            stroke-dasharray: 4, 4;
            stroke-linecap: round;
        }

        .curved-arrow .arrow-head {
            fill: rgba(183, 199, 213, 0.6);
        }

        .app.all-picked .choose,
        .app.all-picked .hint,
        .app.all-picked .curved-arrow,
        .app.all-picked .fan-wrapper {
            opacity: 0;
            pointer-events: none;
        }

        .open-btn {
            position: absolute;
            left: 50%;
            transform: translate(-50%, 14px);
            bottom: 30px;
            padding: 16px 32px;
            background: #E8DCC8;
            color: #2C1810;
            border: 0;
            border-radius: 28px;
            font-weight: 700;
            font-size: 18px;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s, transform 0.3s;
            cursor: pointer;
        }

        .open-btn.show {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, 0);
        }

        .app.flipped .open-btn {
            opacity: 0;
            pointer-events: none;
        }

        .result-btn {
            position: absolute;
            left: 50%;
            transform: translate(-50%, 14px);
            bottom: 30px;
            padding: 16px 32px;
            background: #E8DCC8;
            color: #2C1810;
            border: 0;
            border-radius: 28px;
            font-weight: 700;
            font-size: 18px;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease 0.8s, transform 0.3s ease 0.8s;
            cursor: pointer;
        }

        .result-btn.show {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, 0);
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="topbar">
            <h1>Расклад на день</h1>
        </header>

        <div class="cards-grid">
            <div class="card-slot" id="slot-0">
                <div class="card-slot-inner">
                    <div class="card-face card-empty"></div>
                    <div class="card-face card-front-face"></div>
                </div>
            </div>

            <div class="card-slot" id="slot-1">
                <div class="card-slot-inner">
                    <div class="card-face card-empty"></div>
                    <div class="card-face card-front-face"></div>
                </div>
            </div>

            <div class="card-slot" id="slot-2">
                <div class="card-slot-inner">
                    <div class="card-face card-empty"></div>
                    <div class="card-face card-front-face"></div>
                </div>
            </div>
        </div>

        <p class="hint">
            Выбери 3 карты для расклада на день
        </p>

        <div class="fan-wrapper">
            <div class="fan-container" id="fanContainer"></div>
            <div class="fan-edge-indicator left" id="leftEdge"></div>
            <div class="fan-edge-indicator right" id="rightEdge"></div>
        </div>

        <div class="curved-arrow">
            <svg viewBox="0 0 240 30">
                <defs>
                    <marker id="arrowhead-left" markerWidth="8" markerHeight="6" refX="0" refY="3" orient="auto">
                        <polygon points="8 0, 8 6, 0 3" class="arrow-head" />
                    </marker>
                    <marker id="arrowhead-right" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
                        <polygon points="0 0, 8 3, 0 6" class="arrow-head" />
                    </marker>
                </defs>
                <path d="M 15 15 Q 120 0 225 15" marker-start="url(#arrowhead-left)" marker-end="url(#arrowhead-right)" />
            </svg>
        </div>

        <div class="choose">
            <div>Выбери карту</div>
        </div>

        <button class="open-btn" id="openBtn">Открыть карты</button>
        <button class="result-btn" id="resultBtn">Получить результат</button>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const TAROT_TRANSLATIONS = {
            'The Fool': 'Шут', 'The Magician': 'Маг', 'The High Priestess': 'Верховная Жрица',
            'The Empress': 'Императрица', 'The Emperor': 'Император', 'The Hierophant': 'Иерофант',
            'The Lovers': 'Влюбленные', 'The Chariot': 'Колесница', 'Strength': 'Сила',
            'The Hermit': 'Отшельник', 'Wheel of Fortune': 'Колесо Фортуны', 'Justice': 'Справедливость',
            'The Hanged Man': 'Повешенный', 'Death': 'Смерть', 'Temperance': 'Умеренность',
            'The Devil': 'Дьявол', 'The Tower': 'Башня', 'The Star': 'Звезда',
            'The Moon': 'Луна', 'The Sun': 'Солнце', 'Judgement': 'Суд', 'The World': 'Мир',
            'Ace of Wands': 'Туз Жезлов', 'Two of Wands': 'Двойка Жезлов', 'Three of Wands': 'Тройка Жезлов',
            'Four of Wands': 'Четверка Жезлов', 'Five of Wands': 'Пятерка Жезлов', 'Six of Wands': 'Шестерка Жезлов',
            'Seven of Wands': 'Семерка Жезлов', 'Eight of Wands': 'Восьмерка Жезлов', 'Nine of Wands': 'Девятка Жезлов',
            'Ten of Wands': 'Десятка Жезлов', 'Page of Wands': 'Паж Жезлов', 'Knight of Wands': 'Рыцарь Жезлов',
            'Queen of Wands': 'Королева Жезлов', 'King of Wands': 'Король Жезлов',
            'Ace of Cups': 'Туз Кубков', 'Two of Cups': 'Двойка Кубков', 'Three of Cups': 'Тройка Кубков',
            'Four of Cups': 'Четверка Кубков', 'Five of Cups': 'Пятерка Кубков', 'Six of Cups': 'Шестерка Кубков',
            'Seven of Cups': 'Семерка Кубков', 'Eight of Cups': 'Восьмерка Кубков', 'Nine of Cups': 'Девятка Кубков',
            'Ten of Cups': 'Десятка Кубков', 'Page of Cups': 'Паж Кубков', 'Knight of Cups': 'Рыцарь Кубков',
            'Queen of Cups': 'Королева Кубков', 'King of Cups': 'Король Кубков',
            'Ace of Swords': 'Туз Мечей', 'Two of Swords': 'Двойка Мечей', 'Three of Swords': 'Тройка Мечей',
            'Four of Swords': 'Четверка Мечей', 'Five of Swords': 'Пятерка Мечей', 'Six of Swords': 'Шестерка Мечей',
            'Seven of Swords': 'Семерка Мечей', 'Eight of Swords': 'Восьмерка Мечей', 'Nine of Swords': 'Девятка Мечей',
            'Ten of Swords': 'Десятка Мечей', 'Page of Swords': 'Паж Мечей', 'Knight of Swords': 'Рыцарь Мечей',
            'Queen of Swords': 'Королева Мечей', 'King of Swords': 'Король Мечей',
            'Ace of Pentacles': 'Туз Пентаклей', 'Two of Pentacles': 'Двойка Пентаклей', 'Three of Pentacles': 'Тройка Пентаклей',
            'Four of Pentacles': 'Четверка Пентаклей', 'Five of Pentacles': 'Пятерка Пентаклей', 'Six of Pentacles': 'Шестерка Пентаклей',
            'Seven of Pentacles': 'Семерка Пентаклей', 'Eight of Pentacles': 'Восьмерка Пентаклей', 'Nine of Pentacles': 'Девятка Пентаклей',
            'Ten of Pentacles': 'Десятка Пентаклей', 'Page of Pentacles': 'Паж Пентаклей', 'Knight of Pentacles': 'Рыцарь Пентаклей',
            'Queen of Pentacles': 'Королева Пентаклей', 'King of Pentacles': 'Король Пентаклей'
        };

        function translateCard(englishName) {
            return TAROT_TRANSLATIONS[englishName] || englishName;
        }

        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const fanContainer = document.getElementById('fanContainer');
        const openBtn = document.getElementById('openBtn');
        const resultBtn = document.getElementById('resultBtn');
        const app = document.querySelector('.app');
        const leftEdge = document.getElementById('leftEdge');
        const rightEdge = document.getElementById('rightEdge');
        
        const CARDS_COUNT = 78;
        const TOTAL_ANGLE = 360;
        const CARD_IMAGE = 'images/back-of-the-card-new.png';
        const SLOTS_COUNT = 3;
        
        const TAROT_CARDS = [
            'Ace of Cups', 'Ace of Pentacles', 'Ace of Swords', 'Ace of Wands',
            'Death', 'Eight of Cups', 'Eight of Pentacles', 'Eight of Swords',
            'Eight of Wands', 'Five of Cups', 'Five of Pentacles', 'Five of Swords',
            'Five of Wands', 'Four of Cups', 'Four of Pentacles', 'Four of Swords',
            'Four of Wands', 'Judgement', 'Justice', 'King of Cups',
            'King of Pentacles', 'King of Swords', 'King of Wands', 'Knight of Cups',
            'Knight of Pentacles', 'Knight of Swords', 'Knight of Wands', 'Nine of Cups',
            'Nine of Pentacles', 'Nine of Swords', 'Nine of Wands', 'Page of Cups',
            'Page of Pentacles', 'Page of Swords', 'Page of Wands', 'Queen of Cups',
            'Queen of Pentacles', 'Queen of Swords', 'Queen of Wands', 'Seven of Cups',
            'Seven of Pentacles', 'Seven of Swords', 'Seven of Wands', 'Six of Cups',
            'Six of Pentacles', 'Six of Swords', 'Six of Wands', 'Strength',
            'Temperance', 'Ten of Cups', 'Ten of Pentacles', 'Ten of Swords',
            'Ten of Wands', 'The Chariot', 'The Devil', 'The Emperor',
            'The Empress', 'The Fool', 'The Hanged Man', 'The Hermit',
            'The Hierophant', 'The High Priestess', 'The Lovers', 'The Magician',
            'The Moon', 'The Star', 'The Sun', 'The Tower',
            'The World', 'Three of Cups', 'Three of Pentacles', 'Three of Swords',
            'Three of Wands', 'Two of Cups', 'Two of Pentacles', 'Two of Swords',
            'Two of Wands', 'Wheel of Fortune'
        ];
        
        let currentRotation = 0;
        let isDragging = false;
        let dragDistance = 0;
        let startX = 0;
        let lastRotation = 0;
        let animationFrame = null;
        let selectedCards = [];
        let currentSlot = 0;
        let isAnimating = false;
        
        function createFan() {
            fanContainer.innerHTML = '';
            const angleStep = TOTAL_ANGLE / (CARDS_COUNT - 1);
            
            for (let i = 0; i < CARDS_COUNT; i++) {
                const card = document.createElement('div');
                card.className = 'fan-card';
                card.dataset.index = i;
                
                const img = document.createElement('img');
                img.src = CARD_IMAGE;
                img.alt = 'Card';
                img.draggable = false;
                
                card.appendChild(img);
                
                // 🎯 УНИВЕРСАЛЬНОЕ РЕШЕНИЕ: Клик прямо на карту
                // Работает при ЛЮБОМ масштабе, т.к. браузер сам определяет границы элемента
                card.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Проверяем: не анимация, слот доступен, и не было драга
                    if (!isAnimating && currentSlot < SLOTS_COUNT && card.style.opacity !== '0' && dragDistance < 10) {
                        selectCard(card);
                    }
                });
                
                // 📱 Обработка touch-событий для мобильных устройств
                card.addEventListener('touchend', (e) => {
                    // Если не было драга - это тап по карте
                    if (!isAnimating && currentSlot < SLOTS_COUNT && card.style.opacity !== '0' && dragDistance < 10) {
                        e.preventDefault();
                        e.stopPropagation();
                        selectCard(card);
                    }
                }, {passive: false});
                
                fanContainer.appendChild(card);
                
                const angle = -TOTAL_ANGLE/2 + i * angleStep;
                card.style.transform = `rotate(${angle}deg) translateY(-33.5vh)`;
                card.style.zIndex = i;
            }
        }
        
        function updateFan(rotation) {
            const cards = fanContainer.querySelectorAll('.fan-card');
            const angleStep = TOTAL_ANGLE / (CARDS_COUNT - 1);
            
            cards.forEach((card, i) => {
                const baseAngle = -TOTAL_ANGLE/2 + i * angleStep;
                const angle = baseAngle + rotation;
                card.style.transform = `rotate(${angle}deg) translateY(-33.5vh)`;
                
                // 🔥 НЕ ТРОГАЕМ УЖЕ ВЫБРАННЫЕ КАРТЫ!
                if (card.dataset.selected === 'true') {
                    return;  // Пропускаем выбранные карты
                }
                
                if (Math.abs(angle) > 90) {
                    card.style.opacity = '0';
                    card.style.pointerEvents = 'none';
                } else {
                    card.style.opacity = '1';
                    card.style.pointerEvents = 'auto';
                }
                
                // ✅ Z-index на основе ТЕКУЩЕГО угла (правые карты выше)
                card.style.zIndex = Math.floor(1000 + angle * 10);
            });
            
            updateEdgeIndicators(rotation);
        }
        
        function updateEdgeIndicators(rotation) {
            const maxLeftRotation = TOTAL_ANGLE / 2;
            const maxRightRotation = -TOTAL_ANGLE / 2;
            
            if (rotation >= maxLeftRotation - 5) {
                leftEdge.classList.add('visible');
            } else {
                leftEdge.classList.remove('visible');
            }
            
            if (rotation <= maxRightRotation + 5) {
                rightEdge.classList.add('visible');
            } else {
                rightEdge.classList.remove('visible');
            }
        }
        
        fanContainer.addEventListener('mousedown', startDrag);
        fanContainer.addEventListener('touchstart', startDrag, {passive: false});
        
        function startDrag(e) {
            e.preventDefault();
            isDragging = true;
            dragDistance = 0;
            startX = e.type === 'mousedown' ? e.clientX : e.touches[0].clientX;
            lastRotation = currentRotation;
            fanContainer.style.cursor = 'grabbing';
            
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
                animationFrame = null;
            }
        }
        
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag, {passive: false});
        
        function drag(e) {
            if (!isDragging) return;
            e.preventDefault();
            
            const currentX = e.type === 'mousemove' ? e.clientX : e.touches[0].clientX;
            const deltaX = currentX - startX;
            dragDistance = Math.abs(deltaX);
            
            currentRotation = lastRotation + (deltaX * 0.15);
            
            const maxLeft = TOTAL_ANGLE / 2;
            const maxRight = -TOTAL_ANGLE / 2;
            
            if (currentRotation > maxLeft) {
                const excess = currentRotation - maxLeft;
                currentRotation = maxLeft + excess * 0.3;
            } else if (currentRotation < maxRight) {
                const excess = currentRotation - maxRight;
                currentRotation = maxRight + excess * 0.3;
            }
            
            updateFan(currentRotation);
        }
        
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);
        document.addEventListener('mouseleave', endDrag);
        
        function endDrag(e) {
            if (!isDragging) return;
            
            isDragging = false;
            fanContainer.style.cursor = 'grab';
            
            springBack();
            
            // 🎯 Сбрасываем dragDistance с задержкой
            setTimeout(() => {
                dragDistance = 0;
            }, 100);
        }
        
        function springBack() {
            const maxLeft = TOTAL_ANGLE / 2;
            const maxRight = -TOTAL_ANGLE / 2;
            
            if (currentRotation > maxLeft || currentRotation < maxRight) {
                const targetRotation = currentRotation > maxLeft ? maxLeft : maxRight;
                
                const animate = () => {
                    const diff = targetRotation - currentRotation;
                    
                    if (Math.abs(diff) > 0.5) {
                        currentRotation += diff * 0.15;
                        updateFan(currentRotation);
                        animationFrame = requestAnimationFrame(animate);
                    } else {
                        currentRotation = targetRotation;
                        updateFan(currentRotation);
                        lastRotation = currentRotation;
                        if (animationFrame) {
                            cancelAnimationFrame(animationFrame);
                            animationFrame = null;
                        }
                    }
                };
                
                animate();
            } else {
                lastRotation = currentRotation;
            }
        }
        
        function selectCard(card) {
            if (isAnimating || currentSlot >= SLOTS_COUNT) return;
            
            isAnimating = true;
            
            const targetSlotIndex = currentSlot;
            
            let selectedCardName;
            do {
                selectedCardName = TAROT_CARDS[Math.floor(Math.random() * TAROT_CARDS.length)];
            } while (selectedCards.includes(selectedCardName));
            selectedCards.push(selectedCardName);
            
            const slot = document.getElementById(`slot-${targetSlotIndex}`);
            const targetRect = slot.getBoundingClientRect();
            
            const rect = card.getBoundingClientRect();
            const computedStyle = getComputedStyle(card);
            const transform = computedStyle.transform;
            const matrix = new DOMMatrix(transform);
            const angle = Math.atan2(matrix.b, matrix.a) * (180 / Math.PI);
            
            card.style.opacity = '0';
            card.style.pointerEvents = 'none';
            card.dataset.selected = 'true';  // 🔥 ПОМЕЧАЕМ КАК ВЫБРАННУЮ
            
            // 🎯 ИСПРАВЛЕНИЕ: Используем фиксированные размеры карты
            const CARD_WIDTH = 106;
            const CARD_HEIGHT = 190;
            
            // Вычисляем центр повернутой карты
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            const copy = document.createElement('div');
            copy.className = 'fan-card animating-copy';
            copy.innerHTML = card.innerHTML;
            copy.style.position = 'fixed';
            // Позиционируем копию по центру с фиксированными размерами
            copy.style.left = (centerX - CARD_WIDTH / 2) + 'px';
            copy.style.top = (centerY - CARD_HEIGHT / 2) + 'px';
            copy.style.width = CARD_WIDTH + 'px';
            copy.style.height = CARD_HEIGHT + 'px';
            copy.style.margin = '0';
            copy.style.transform = `rotate(${angle}deg)`;
            copy.style.transformOrigin = 'center center';
            copy.style.zIndex = '3000';
            copy.style.pointerEvents = 'none';
            copy.style.outline = 'none';
            copy.style.border = 'none';
            copy.style.webkitTapHighlightColor = 'rgba(0,0,0,0)';
            
            document.body.appendChild(copy);
            
            // Убираем рамки у img внутри копии
            const copyImg = copy.querySelector('img');
            if (copyImg) {
                copyImg.style.outline = 'none';
                copyImg.style.border = 'none';
                copyImg.style.boxShadow = 'none';
            }
            
            copy.offsetHeight;
            
            requestAnimationFrame(() => {
                copy.style.transition = 'transform 200ms ease-out';
                copy.style.transform = `rotate(${angle}deg) translateY(-50px)`;
                
                setTimeout(() => {
                    copy.style.transition = 'all 800ms cubic-bezier(0.4, 0, 0.2, 1)';
                    copy.style.left = targetRect.left + 'px';
                    copy.style.top = targetRect.top + 'px';
                    copy.style.width = targetRect.width + 'px';
                    copy.style.height = targetRect.height + 'px';
                    copy.style.transform = 'rotate(0deg) translateY(0)';
                }, 200);
                
                setTimeout(() => {
                    const emptySlot = slot.querySelector('.card-empty');
                    emptySlot.classList.remove('card-empty');
                    emptySlot.classList.add('card-back-face');
                    
                    const cardFrontFace = slot.querySelector('.card-front-face');
                    const img = document.createElement('img');
                    img.src = `tarot_correct_names/${selectedCardName}.png`;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'contain';
                    img.style.imageRendering = '-webkit-optimize-contrast';
                    cardFrontFace.appendChild(img);
                    
                    copy.style.opacity = '0';
                    copy.style.transition = 'opacity 300ms';
                    setTimeout(() => copy.remove(), 300);
                    
                    currentSlot++;
                    
                    setTimeout(() => {
                        isAnimating = false;
                        
                        if (currentSlot >= SLOTS_COUNT) {
                            app.classList.add('all-picked');
                            fanContainer.style.pointerEvents = 'none';
                            
                            setTimeout(() => {
                                openBtn.classList.add('show');
                            }, 200);
                        }
                    }, 100);
                }, 1000);
            });
        }
        
        openBtn.addEventListener('click', () => {
            openBtn.classList.remove('show');
            
            setTimeout(() => {
                for (let i = 0; i < SLOTS_COUNT; i++) {
                    setTimeout(() => {
                        const flipSlot = document.getElementById(`slot-${i}`);
                        flipSlot.classList.add('flipped');
                    }, i * 600);
                }
                
                app.classList.add('flipped');
                
                setTimeout(() => {
                    resultBtn.classList.add('show');
                }, SLOTS_COUNT * 600 + 500);
            }, 300);
        });
        
        resultBtn.addEventListener('click', () => {
            const data = JSON.stringify({
                cards: selectedCards,
                type: 'day_spread'
            });
            
            tg.sendData(data);
        });
        
        createFan();
        updateFan(currentRotation);
    </script>
</body>
</html>
