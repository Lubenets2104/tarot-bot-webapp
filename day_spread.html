<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–†–∞—Å–∫–ª–∞–¥ –Ω–∞ –¥–µ–Ω—å - –¢–∞—Ä–æ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            -webkit-tap-highlight-color: transparent;
            outline: none !important;
            -webkit-touch-callout: none !important;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
        }

        body {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            font-family: Georgia, serif;
            user-select: none;
            -webkit-user-select: none;
            touch-action: pan-y;
        }

        .app {
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
            background: url('images/bg-new.jpg') center center no-repeat;
            background-size: cover;
        }

        .topbar {
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .topbar h1 {
            font-weight: 700;
            font-size: 20px;
            color: #fff;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .cards-grid {
            width: 100%;
            max-width: 360px;
            margin: 24px auto 0;
            padding: 0 16px;
            display: grid;
            grid-template-columns: repeat(3, 106px);
            grid-template-rows: 190px;
            gap: 12px;
            justify-content: center;
        }

        .card-slot {
            width: 106px;
            height: 190px;
            position: relative;
            perspective: 1000px;
        }

        .card-slot-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }

        .card-slot.flipped .card-slot-inner {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 0;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        .card-empty {
            background: rgba(20, 44, 52, 0.3);
            border: none;
            border-radius: 0;
            box-shadow: 0 0 0 1px rgba(248, 252, 255, 0.15) inset,
                        0 8px 20px rgba(0, 0, 0, 0.3);
            z-index: 2;
        }

        .card-back-face {
            background: url("images/back-of-the-card-new.png") center/cover no-repeat;
            border: none;
            border-radius: 0;
            box-shadow: 0 0 0 1px rgba(248, 252, 255, 0.3) inset,
                        0 8px 20px rgba(0, 0, 0, 0.5);
            z-index: 2;
        }

        .card-front-face {
            background: #fff;
            transform: rotateY(180deg);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: none;
            border-radius: 0;
            box-shadow: 0 0 0 1px rgba(248, 252, 255, 0.3) inset,
                        0 8px 20px rgba(0, 0, 0, 0.5);
        }

        .card-front-face img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: high-quality;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .hint {
            text-align: center;
            color: #b7c7d5;
            line-height: 1.35;
            font-size: 13px;
            margin: 24px 16px 0;
            transition: opacity 0.35s ease;
        }

        .fan-wrapper {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            height: 35vh;
            overflow: hidden;
            pointer-events: none;
            z-index: 100;
        }

        .fan-container {
            position: absolute;
            width: 1600px;
            height: 56vh;
            left: 50%;
            bottom: calc(-56vh + 35vh);
            transform: translateX(-50%);
            pointer-events: auto;
            cursor: grab;
        }

        .fan-container:active {
            cursor: grabbing;
        }

        .fan-card {
            position: absolute;
            width: 106px;
            height: 190px;
            left: 50%;
            bottom: 0;
            margin-left: -53px;
            transform-origin: center 33.5vh;
            pointer-events: auto;
            cursor: pointer;
            outline: none !important;
            border: none !important;
            -webkit-tap-highlight-color: rgba(0,0,0,0) !important;
            -webkit-tap-highlight-color: transparent !important;
            -webkit-touch-callout: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
            touch-action: none !important;
            border-radius: 0;
            overflow: hidden;
            box-shadow: 
                0 2px 6px rgba(0, 0, 0, 0.4),
                0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .fan-card:focus,
        .fan-card:active,
        .fan-card:focus-visible {
            outline: none !important;
            border: none !important;
        }

        .fan-card::before,
        .fan-card::after {
            display: none !important;
        }

        .fan-card img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 0;
            border: none !important;
            box-shadow: none !important;
            pointer-events: none;
            outline: none !important;
            -webkit-user-drag: none;
            -webkit-tap-highlight-color: rgba(0,0,0,0) !important;
            background: transparent;
            display: block;
            touch-action: none !important;
        }

        .fan-card img:focus,
        .fan-card img:active {
            outline: none !important;
            border: none !important;
        }

        .fan-card.animating-copy {
            outline: none !important;
            border: none !important;
            -webkit-tap-highlight-color: rgba(0,0,0,0) !important;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4),
                        0 4px 12px rgba(0, 0, 0, 0.3) !important;
        }

        .fan-edge-indicator {
            position: absolute;
            width: 20px;
            height: 100%;
            top: 0;
            background: linear-gradient(90deg, rgba(22, 39, 52, 0) 0%, rgba(22, 39, 52, 0.8) 100%);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .fan-edge-indicator.left {
            left: 0;
            background: linear-gradient(270deg, rgba(22, 39, 52, 0) 0%, rgba(22, 39, 52, 0.8) 100%);
        }

        .fan-edge-indicator.right {
            right: 0;
        }

        .fan-edge-indicator.visible {
            opacity: 1;
        }

        .choose {
            position: absolute;
            left: 50%;
            bottom: 10px;
            transform: translateX(-50%);
            text-align: center;
            color: rgba(183, 199, 213, 0.9);
            font-size: 13px;
            pointer-events: none;
            transition: opacity 0.35s ease;
            z-index: 10;
        }

        .curved-arrow {
            position: absolute;
            left: 50%;
            bottom: 28px;
            transform: translateX(-50%);
            width: 240px;
            height: 30px;
            pointer-events: none;
            z-index: 9;
        }

        .curved-arrow svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        .curved-arrow path {
            fill: none;
            stroke: rgba(183, 199, 213, 0.6);
            stroke-width: 1.5;
            stroke-dasharray: 4, 4;
            stroke-linecap: round;
        }

        .curved-arrow .arrow-head {
            fill: rgba(183, 199, 213, 0.6);
        }

        .app.all-picked .choose,
        .app.all-picked .hint,
        .app.all-picked .curved-arrow,
        .app.all-picked .fan-wrapper {
            opacity: 0;
            pointer-events: none;
        }

        .open-btn {
            position: absolute;
            left: 50%;
            transform: translate(-50%, 14px);
            bottom: 30px;
            padding: 16px 32px;
            background: #E8DCC8;
            color: #2C1810;
            border: 0;
            border-radius: 28px;
            font-weight: 700;
            font-size: 18px;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s, transform 0.3s;
            cursor: pointer;
        }

        .open-btn.show {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, 0);
        }

        .app.flipped .open-btn {
            opacity: 0;
            pointer-events: none;
        }

        .result-btn {
            position: absolute;
            left: 50%;
            transform: translate(-50%, 14px);
            bottom: 30px;
            padding: 16px 32px;
            background: #E8DCC8;
            color: #2C1810;
            border: 0;
            border-radius: 28px;
            font-weight: 700;
            font-size: 18px;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease 0.8s, transform 0.3s ease 0.8s;
            cursor: pointer;
        }

        .result-btn.show {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, 0);
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="topbar">
            <h1>–†–∞—Å–∫–ª–∞–¥ –Ω–∞ –¥–µ–Ω—å</h1>
        </header>

        <div class="cards-grid">
            <div class="card-slot" id="slot-0">
                <div class="card-slot-inner">
                    <div class="card-face card-empty"></div>
                    <div class="card-face card-front-face"></div>
                </div>
            </div>

            <div class="card-slot" id="slot-1">
                <div class="card-slot-inner">
                    <div class="card-face card-empty"></div>
                    <div class="card-face card-front-face"></div>
                </div>
            </div>

            <div class="card-slot" id="slot-2">
                <div class="card-slot-inner">
                    <div class="card-face card-empty"></div>
                    <div class="card-face card-front-face"></div>
                </div>
            </div>
        </div>

        <p class="hint">
            –í—ã–±–µ—Ä–∏ 3 –∫–∞—Ä—Ç—ã –¥–ª—è —Ä–∞—Å–∫–ª–∞–¥–∞ –Ω–∞ –¥–µ–Ω—å
        </p>

        <div class="fan-wrapper">
            <div class="fan-container" id="fanContainer"></div>
            <div class="fan-edge-indicator left" id="leftEdge"></div>
            <div class="fan-edge-indicator right" id="rightEdge"></div>
        </div>

        <div class="curved-arrow">
            <svg viewBox="0 0 240 30">
                <defs>
                    <marker id="arrowhead-left" markerWidth="8" markerHeight="6" refX="0" refY="3" orient="auto">
                        <polygon points="8 0, 8 6, 0 3" class="arrow-head" />
                    </marker>
                    <marker id="arrowhead-right" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
                        <polygon points="0 0, 8 3, 0 6" class="arrow-head" />
                    </marker>
                </defs>
                <path d="M 15 15 Q 120 0 225 15" marker-start="url(#arrowhead-left)" marker-end="url(#arrowhead-right)" />
            </svg>
        </div>

        <div class="choose">
            <div>–í—ã–±–µ—Ä–∏ –∫–∞—Ä—Ç—É</div>
        </div>

        <button class="open-btn" id="openBtn">–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—ã</button>
        <button class="result-btn" id="resultBtn">–ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const TAROT_TRANSLATIONS = {
            'The Fool': '–®—É—Ç', 'The Magician': '–ú–∞–≥', 'The High Priestess': '–í–µ—Ä—Ö–æ–≤–Ω–∞—è –ñ—Ä–∏—Ü–∞',
            'The Empress': '–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞', 'The Emperor': '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä', 'The Hierophant': '–ò–µ—Ä–æ—Ñ–∞–Ω—Ç',
            'The Lovers': '–í–ª—é–±–ª–µ–Ω–Ω—ã–µ', 'The Chariot': '–ö–æ–ª–µ—Å–Ω–∏—Ü–∞', 'Strength': '–°–∏–ª–∞',
            'The Hermit': '–û—Ç—à–µ–ª—å–Ω–∏–∫', 'Wheel of Fortune': '–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã', 'Justice': '–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å',
            'The Hanged Man': '–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π', 'Death': '–°–º–µ—Ä—Ç—å', 'Temperance': '–£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å',
            'The Devil': '–î—å—è–≤–æ–ª', 'The Tower': '–ë–∞—à–Ω—è', 'The Star': '–ó–≤–µ–∑–¥–∞',
            'The Moon': '–õ—É–Ω–∞', 'The Sun': '–°–æ–ª–Ω—Ü–µ', 'Judgement': '–°—É–¥', 'The World': '–ú–∏—Ä',
            'Ace of Wands': '–¢—É–∑ –ñ–µ–∑–ª–æ–≤', 'Two of Wands': '–î–≤–æ–π–∫–∞ –ñ–µ–∑–ª–æ–≤', 'Three of Wands': '–¢—Ä–æ–π–∫–∞ –ñ–µ–∑–ª–æ–≤',
            'Four of Wands': '–ß–µ—Ç–≤–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤', 'Five of Wands': '–ü—è—Ç–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤', 'Six of Wands': '–®–µ—Å—Ç–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤',
            'Seven of Wands': '–°–µ–º–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤', 'Eight of Wands': '–í–æ—Å—å–º–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤', 'Nine of Wands': '–î–µ–≤—è—Ç–∫–∞ –ñ–µ–∑–ª–æ–≤',
            'Ten of Wands': '–î–µ—Å—è—Ç–∫–∞ –ñ–µ–∑–ª–æ–≤', 'Page of Wands': '–ü–∞–∂ –ñ–µ–∑–ª–æ–≤', 'Knight of Wands': '–†—ã—Ü–∞—Ä—å –ñ–µ–∑–ª–æ–≤',
            'Queen of Wands': '–ö–æ—Ä–æ–ª–µ–≤–∞ –ñ–µ–∑–ª–æ–≤', 'King of Wands': '–ö–æ—Ä–æ–ª—å –ñ–µ–∑–ª–æ–≤',
            'Ace of Cups': '–¢—É–∑ –ö—É–±–∫–æ–≤', 'Two of Cups': '–î–≤–æ–π–∫–∞ –ö—É–±–∫–æ–≤', 'Three of Cups': '–¢—Ä–æ–π–∫–∞ –ö—É–±–∫–æ–≤',
            'Four of Cups': '–ß–µ—Ç–≤–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤', 'Five of Cups': '–ü—è—Ç–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤', 'Six of Cups': '–®–µ—Å—Ç–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤',
            'Seven of Cups': '–°–µ–º–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤', 'Eight of Cups': '–í–æ—Å—å–º–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤', 'Nine of Cups': '–î–µ–≤—è—Ç–∫–∞ –ö—É–±–∫–æ–≤',
            'Ten of Cups': '–î–µ—Å—è—Ç–∫–∞ –ö—É–±–∫–æ–≤', 'Page of Cups': '–ü–∞–∂ –ö—É–±–∫–æ–≤', 'Knight of Cups': '–†—ã—Ü–∞—Ä—å –ö—É–±–∫–æ–≤',
            'Queen of Cups': '–ö–æ—Ä–æ–ª–µ–≤–∞ –ö—É–±–∫–æ–≤', 'King of Cups': '–ö–æ—Ä–æ–ª—å –ö—É–±–∫–æ–≤',
            'Ace of Swords': '–¢—É–∑ –ú–µ—á–µ–π', 'Two of Swords': '–î–≤–æ–π–∫–∞ –ú–µ—á–µ–π', 'Three of Swords': '–¢—Ä–æ–π–∫–∞ –ú–µ—á–µ–π',
            'Four of Swords': '–ß–µ—Ç–≤–µ—Ä–∫–∞ –ú–µ—á–µ–π', 'Five of Swords': '–ü—è—Ç–µ—Ä–∫–∞ –ú–µ—á–µ–π', 'Six of Swords': '–®–µ—Å—Ç–µ—Ä–∫–∞ –ú–µ—á–µ–π',
            'Seven of Swords': '–°–µ–º–µ—Ä–∫–∞ –ú–µ—á–µ–π', 'Eight of Swords': '–í–æ—Å—å–º–µ—Ä–∫–∞ –ú–µ—á–µ–π', 'Nine of Swords': '–î–µ–≤—è—Ç–∫–∞ –ú–µ—á–µ–π',
            'Ten of Swords': '–î–µ—Å—è—Ç–∫–∞ –ú–µ—á–µ–π', 'Page of Swords': '–ü–∞–∂ –ú–µ—á–µ–π', 'Knight of Swords': '–†—ã—Ü–∞—Ä—å –ú–µ—á–µ–π',
            'Queen of Swords': '–ö–æ—Ä–æ–ª–µ–≤–∞ –ú–µ—á–µ–π', 'King of Swords': '–ö–æ—Ä–æ–ª—å –ú–µ—á–µ–π',
            'Ace of Pentacles': '–¢—É–∑ –ü–µ–Ω—Ç–∞–∫–ª–µ–π', 'Two of Pentacles': '–î–≤–æ–π–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π', 'Three of Pentacles': '–¢—Ä–æ–π–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π',
            'Four of Pentacles': '–ß–µ—Ç–≤–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π', 'Five of Pentacles': '–ü—è—Ç–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π', 'Six of Pentacles': '–®–µ—Å—Ç–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π',
            'Seven of Pentacles': '–°–µ–º–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π', 'Eight of Pentacles': '–í–æ—Å—å–º–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π', 'Nine of Pentacles': '–î–µ–≤—è—Ç–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π',
            'Ten of Pentacles': '–î–µ—Å—è—Ç–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π', 'Page of Pentacles': '–ü–∞–∂ –ü–µ–Ω—Ç–∞–∫–ª–µ–π', 'Knight of Pentacles': '–†—ã—Ü–∞—Ä—å –ü–µ–Ω—Ç–∞–∫–ª–µ–π',
            'Queen of Pentacles': '–ö–æ—Ä–æ–ª–µ–≤–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π', 'King of Pentacles': '–ö–æ—Ä–æ–ª—å –ü–µ–Ω—Ç–∞–∫–ª–µ–π'
        };

        function translateCard(englishName) {
            return TAROT_TRANSLATIONS[englishName] || englishName;
        }

        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const fanContainer = document.getElementById('fanContainer');
        const openBtn = document.getElementById('openBtn');
        const resultBtn = document.getElementById('resultBtn');
        const app = document.querySelector('.app');
        const leftEdge = document.getElementById('leftEdge');
        const rightEdge = document.getElementById('rightEdge');
        
        const CARDS_COUNT = 78;
        const TOTAL_ANGLE = 360;
        const CARD_IMAGE = 'images/back-of-the-card-new.png';
        const SLOTS_COUNT = 3;
        
        const TAROT_CARDS = [
            'Ace of Cups', 'Ace of Pentacles', 'Ace of Swords', 'Ace of Wands',
            'Death', 'Eight of Cups', 'Eight of Pentacles', 'Eight of Swords',
            'Eight of Wands', 'Five of Cups', 'Five of Pentacles', 'Five of Swords',
            'Five of Wands', 'Four of Cups', 'Four of Pentacles', 'Four of Swords',
            'Four of Wands', 'Judgement', 'Justice', 'King of Cups',
            'King of Pentacles', 'King of Swords', 'King of Wands', 'Knight of Cups',
            'Knight of Pentacles', 'Knight of Swords', 'Knight of Wands', 'Nine of Cups',
            'Nine of Pentacles', 'Nine of Swords', 'Nine of Wands', 'Page of Cups',
            'Page of Pentacles', 'Page of Swords', 'Page of Wands', 'Queen of Cups',
            'Queen of Pentacles', 'Queen of Swords', 'Queen of Wands', 'Seven of Cups',
            'Seven of Pentacles', 'Seven of Swords', 'Seven of Wands', 'Six of Cups',
            'Six of Pentacles', 'Six of Swords', 'Six of Wands', 'Strength',
            'Temperance', 'Ten of Cups', 'Ten of Pentacles', 'Ten of Swords',
            'Ten of Wands', 'The Chariot', 'The Devil', 'The Emperor',
            'The Empress', 'The Fool', 'The Hanged Man', 'The Hermit',
            'The Hierophant', 'The High Priestess', 'The Lovers', 'The Magician',
            'The Moon', 'The Star', 'The Sun', 'The Tower',
            'The World', 'Three of Cups', 'Three of Pentacles', 'Three of Swords',
            'Three of Wands', 'Two of Cups', 'Two of Pentacles', 'Two of Swords',
            'Two of Wands', 'Wheel of Fortune'
        ];
        
        let currentRotation = 0;
        let isDragging = false;
        let dragDistance = 0;
        let startX = 0;
        let lastRotation = 0;
        let animationFrame = null;
        let selectedCards = [];
        let currentSlot = 0;
        let isAnimating = false;
        
        function createFan() {
            fanContainer.innerHTML = '';
            const angleStep = TOTAL_ANGLE / (CARDS_COUNT - 1);
            
            for (let i = 0; i < CARDS_COUNT; i++) {
                const card = document.createElement('div');
                card.className = 'fan-card';
                card.dataset.index = i;
                
                const img = document.createElement('img');
                img.src = CARD_IMAGE;
                img.alt = 'Card';
                img.draggable = false;
                
                card.appendChild(img);
                
                // üéØ –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï: –ö–ª–∏–∫ –ø—Ä—è–º–æ –Ω–∞ –∫–∞—Ä—Ç—É
                // –†–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –õ–Æ–ë–û–ú –º–∞—Å—à—Ç–∞–±–µ, —Ç.–∫. –±—Ä–∞—É–∑–µ—Ä —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≥—Ä–∞–Ω–∏—Ü—ã —ç–ª–µ–º–µ–Ω—Ç–∞
                card.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –Ω–µ –∞–Ω–∏–º–∞—Ü–∏—è, —Å–ª–æ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω, –∏ –Ω–µ –±—ã–ª–æ –¥—Ä–∞–≥–∞
                    if (!isAnimating && currentSlot < SLOTS_COUNT && card.style.opacity !== '0' && dragDistance < 10) {
                        selectCard(card);
                    }
                });
                
                // üì± –û–±—Ä–∞–±–æ—Ç–∫–∞ touch-—Å–æ–±—ã—Ç–∏–π –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                card.addEventListener('touchend', (e) => {
                    // –ï—Å–ª–∏ –Ω–µ –±—ã–ª–æ –¥—Ä–∞–≥–∞ - —ç—Ç–æ —Ç–∞–ø –ø–æ –∫–∞—Ä—Ç–µ
                    if (!isAnimating && currentSlot < SLOTS_COUNT && card.style.opacity !== '0' && dragDistance < 10) {
                        e.preventDefault();
                        e.stopPropagation();
                        selectCard(card);
                    }
                }, {passive: false});
                
                fanContainer.appendChild(card);
                
                const angle = -TOTAL_ANGLE/2 + i * angleStep;
                card.style.transform = `rotate(${angle}deg) translateY(-33.5vh)`;
                card.style.zIndex = i;
            }
        }
        
        function updateFan(rotation) {
            const cards = fanContainer.querySelectorAll('.fan-card');
            const angleStep = TOTAL_ANGLE / (CARDS_COUNT - 1);
            
            cards.forEach((card, i) => {
                const baseAngle = -TOTAL_ANGLE/2 + i * angleStep;
                const angle = baseAngle + rotation;
                card.style.transform = `rotate(${angle}deg) translateY(-33.5vh)`;
                
                // üî• –ù–ï –¢–†–û–ì–ê–ï–ú –£–ñ–ï –í–´–ë–†–ê–ù–ù–´–ï –ö–ê–†–¢–´!
                if (card.dataset.selected === 'true') {
                    return;  // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã
                }
                
                if (Math.abs(angle) > 90) {
                    card.style.opacity = '0';
                    card.style.pointerEvents = 'none';
                } else {
                    card.style.opacity = '1';
                    card.style.pointerEvents = 'auto';
                }
                
                // ‚úÖ Z-index –Ω–∞ –æ—Å–Ω–æ–≤–µ –¢–ï–ö–£–©–ï–ì–û —É–≥–ª–∞ (–ø—Ä–∞–≤—ã–µ –∫–∞—Ä—Ç—ã –≤—ã—à–µ)
                card.style.zIndex = Math.floor(1000 + angle * 10);
            });
            
            updateEdgeIndicators(rotation);
        }
        
        function updateEdgeIndicators(rotation) {
            const maxLeftRotation = TOTAL_ANGLE / 2;
            const maxRightRotation = -TOTAL_ANGLE / 2;
            
            if (rotation >= maxLeftRotation - 5) {
                leftEdge.classList.add('visible');
            } else {
                leftEdge.classList.remove('visible');
            }
            
            if (rotation <= maxRightRotation + 5) {
                rightEdge.classList.add('visible');
            } else {
                rightEdge.classList.remove('visible');
            }
        }
        
        fanContainer.addEventListener('mousedown', startDrag);
        fanContainer.addEventListener('touchstart', startDrag, {passive: false});
        
        function startDrag(e) {
            e.preventDefault();
            isDragging = true;
            dragDistance = 0;
            startX = e.type === 'mousedown' ? e.clientX : e.touches[0].clientX;
            lastRotation = currentRotation;
            fanContainer.style.cursor = 'grabbing';
            
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
                animationFrame = null;
            }
        }
        
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag, {passive: false});
        
        function drag(e) {
            if (!isDragging) return;
            e.preventDefault();
            
            const currentX = e.type === 'mousemove' ? e.clientX : e.touches[0].clientX;
            const deltaX = currentX - startX;
            dragDistance = Math.abs(deltaX);
            
            currentRotation = lastRotation + (deltaX * 0.15);
            
            const maxLeft = TOTAL_ANGLE / 2;
            const maxRight = -TOTAL_ANGLE / 2;
            
            if (currentRotation > maxLeft) {
                const excess = currentRotation - maxLeft;
                currentRotation = maxLeft + excess * 0.3;
            } else if (currentRotation < maxRight) {
                const excess = currentRotation - maxRight;
                currentRotation = maxRight + excess * 0.3;
            }
            
            updateFan(currentRotation);
        }
        
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);
        document.addEventListener('mouseleave', endDrag);
        
        function endDrag(e) {
            if (!isDragging) return;
            
            isDragging = false;
            fanContainer.style.cursor = 'grab';
            
            springBack();
            
            // üéØ –°–±—Ä–∞—Å—ã–≤–∞–µ–º dragDistance —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
            setTimeout(() => {
                dragDistance = 0;
            }, 100);
        }
        
        function springBack() {
            const maxLeft = TOTAL_ANGLE / 2;
            const maxRight = -TOTAL_ANGLE / 2;
            
            if (currentRotation > maxLeft || currentRotation < maxRight) {
                const targetRotation = currentRotation > maxLeft ? maxLeft : maxRight;
                
                const animate = () => {
                    const diff = targetRotation - currentRotation;
                    
                    if (Math.abs(diff) > 0.5) {
                        currentRotation += diff * 0.15;
                        updateFan(currentRotation);
                        animationFrame = requestAnimationFrame(animate);
                    } else {
                        currentRotation = targetRotation;
                        updateFan(currentRotation);
                        lastRotation = currentRotation;
                        if (animationFrame) {
                            cancelAnimationFrame(animationFrame);
                            animationFrame = null;
                        }
                    }
                };
                
                animate();
            } else {
                lastRotation = currentRotation;
            }
        }
        
        function selectCard(card) {
            if (isAnimating || currentSlot >= SLOTS_COUNT) return;
            
            isAnimating = true;
            
            const targetSlotIndex = currentSlot;
            
            let selectedCardName;
            do {
                selectedCardName = TAROT_CARDS[Math.floor(Math.random() * TAROT_CARDS.length)];
            } while (selectedCards.includes(selectedCardName));
            selectedCards.push(selectedCardName);
            
            const slot = document.getElementById(`slot-${targetSlotIndex}`);
            const targetRect = slot.getBoundingClientRect();
            
            const rect = card.getBoundingClientRect();
            const computedStyle = getComputedStyle(card);
            const transform = computedStyle.transform;
            const matrix = new DOMMatrix(transform);
            const angle = Math.atan2(matrix.b, matrix.a) * (180 / Math.PI);
            
            card.style.opacity = '0';
            card.style.pointerEvents = 'none';
            card.dataset.selected = 'true';  // üî• –ü–û–ú–ï–ß–ê–ï–ú –ö–ê–ö –í–´–ë–†–ê–ù–ù–£–Æ
            
            // üéØ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∫–∞—Ä—Ç—ã
            const CARD_WIDTH = 106;
            const CARD_HEIGHT = 190;
            
            // –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—Ç—Ä –ø–æ–≤–µ—Ä–Ω—É—Ç–æ–π –∫–∞—Ä—Ç—ã
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            const copy = document.createElement('div');
            copy.className = 'fan-card animating-copy';
            copy.innerHTML = card.innerHTML;
            copy.style.position = 'fixed';
            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –∫–æ–ø–∏—é –ø–æ —Ü–µ–Ω—Ç—Ä—É —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏
            copy.style.left = (centerX - CARD_WIDTH / 2) + 'px';
            copy.style.top = (centerY - CARD_HEIGHT / 2) + 'px';
            copy.style.width = CARD_WIDTH + 'px';
            copy.style.height = CARD_HEIGHT + 'px';
            copy.style.margin = '0';
            copy.style.transform = `rotate(${angle}deg)`;
            copy.style.transformOrigin = 'center center';
            copy.style.zIndex = '3000';
            copy.style.pointerEvents = 'none';
            copy.style.outline = 'none';
            copy.style.border = 'none';
            copy.style.webkitTapHighlightColor = 'rgba(0,0,0,0)';
            
            document.body.appendChild(copy);
            
            // –£–±–∏—Ä–∞–µ–º —Ä–∞–º–∫–∏ —É img –≤–Ω—É—Ç—Ä–∏ –∫–æ–ø–∏–∏
            const copyImg = copy.querySelector('img');
            if (copyImg) {
                copyImg.style.outline = 'none';
                copyImg.style.border = 'none';
                copyImg.style.boxShadow = 'none';
            }
            
            copy.offsetHeight;
            
            requestAnimationFrame(() => {
                copy.style.transition = 'transform 200ms ease-out';
                copy.style.transform = `rotate(${angle}deg) translateY(-50px)`;
                
                setTimeout(() => {
                    copy.style.transition = 'all 800ms cubic-bezier(0.4, 0, 0.2, 1)';
                    copy.style.left = targetRect.left + 'px';
                    copy.style.top = targetRect.top + 'px';
                    copy.style.width = targetRect.width + 'px';
                    copy.style.height = targetRect.height + 'px';
                    copy.style.transform = 'rotate(0deg) translateY(0)';
                }, 200);
                
                setTimeout(() => {
                    const emptySlot = slot.querySelector('.card-empty');
                    emptySlot.classList.remove('card-empty');
                    emptySlot.classList.add('card-back-face');
                    
                    const cardFrontFace = slot.querySelector('.card-front-face');
                    const img = document.createElement('img');
                    img.src = `tarot_correct_names/${selectedCardName}.png`;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'contain';
                    img.style.imageRendering = '-webkit-optimize-contrast';
                    cardFrontFace.appendChild(img);
                    
                    copy.style.opacity = '0';
                    copy.style.transition = 'opacity 300ms';
                    setTimeout(() => copy.remove(), 300);
                    
                    currentSlot++;
                    
                    setTimeout(() => {
                        isAnimating = false;
                        
                        if (currentSlot >= SLOTS_COUNT) {
                            app.classList.add('all-picked');
                            fanContainer.style.pointerEvents = 'none';
                            
                            setTimeout(() => {
                                openBtn.classList.add('show');
                            }, 200);
                        }
                    }, 100);
                }, 1000);
            });
        }
        
        openBtn.addEventListener('click', () => {
            openBtn.classList.remove('show');
            
            setTimeout(() => {
                for (let i = 0; i < SLOTS_COUNT; i++) {
                    setTimeout(() => {
                        const flipSlot = document.getElementById(`slot-${i}`);
                        flipSlot.classList.add('flipped');
                    }, i * 600);
                }
                
                app.classList.add('flipped');
                
                setTimeout(() => {
                    resultBtn.classList.add('show');
                }, SLOTS_COUNT * 600 + 500);
            }, 300);
        });
        
        resultBtn.addEventListener('click', () => {
            const data = JSON.stringify({
                cards: selectedCards,
                type: 'day_spread'
            });
            
            tg.sendData(data);
        });
        
        createFan();
        updateFan(currentRotation);
    </script>
</body>
</html>
